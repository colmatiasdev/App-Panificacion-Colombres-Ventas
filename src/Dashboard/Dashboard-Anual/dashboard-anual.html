<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard anual - Panificacion Colombres</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../Footer/footer.css">
  <style>
    :root {
      --rojo:        #C41E3A;
      --rojo-dark:   #9b1730;
      --rojo-light:  #e84a67;
      --rojo-xlight: #ff8fa3;
      --rojo-glass:  rgba(196,30,58,.08);
      --rojo-glow:   rgba(196,30,58,.22);
      --verde:       #22c55e;
      --verde-glass: rgba(34,197,94,.12);
      --amber:       #f59e0b;
      --amber-glass: rgba(245,158,11,.12);
      --bg:          #f2f0ed;
      --surface:     #ffffff;
      --surface2:    #faf9f8;
      --surface3:    #f5f3f1;
      --border:      #e6e2dd;
      --text:        #1a1614;
      --text-muted:  #7a7370;
      --text-light:  #b5b0aa;
      --radius:      10px;
      --radius-lg:   16px;
      --radius-xl:   22px;
      --shadow-sm:   0 1px 3px rgba(0,0,0,.06);
      --shadow:      0 4px 16px rgba(0,0,0,.08);
      --shadow-lg:   0 8px 32px rgba(0,0,0,.12);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Sora', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    .hdr {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      height: 58px;
      padding: 0 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky; top: 0; z-index: 200;
      box-shadow: var(--shadow-sm);
    }
    .hdr-brand { display: flex; align-items: baseline; gap: .5rem; }
    .hdr-brand h1 { font-size: 1.1rem; font-weight: 800; color: var(--rojo); letter-spacing: -.03em; }
    .hdr-brand span { font-size: .72rem; color: var(--text-muted); font-weight: 300; }
    .hdr-nav { display: flex; gap: .2rem; }
    .hdr-nav a {
      padding: .35rem .8rem; border-radius: 8px; font-size: .82rem; font-weight: 600;
      color: var(--text-muted); text-decoration: none; transition: all .15s;
    }
    .hdr-nav a:hover { background: var(--rojo-glass); color: var(--rojo); }
    .hdr-nav a.active { background: var(--rojo); color: #fff; }

    /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
    .main { max-width: 1400px; margin: 0 auto; padding: 2rem 1.5rem 4rem; }

    /* ‚îÄ‚îÄ PAGE TOP ‚îÄ‚îÄ */
    .page-top {
      display: flex; align-items: flex-end; justify-content: space-between;
      flex-wrap: wrap; gap: 1rem; margin-bottom: 1.75rem;
    }
    .back-link {
      font-size: .75rem; color: var(--text-muted); text-decoration: none;
      display: inline-flex; align-items: center; gap: .3rem;
      margin-bottom: .3rem; transition: color .15s;
    }
    .back-link:hover { color: var(--rojo); }
    .page-title { font-size: 1.8rem; font-weight: 800; letter-spacing: -.04em; }
    .page-title em { color: var(--rojo); font-style: normal; }

    /* ‚îÄ‚îÄ YEAR SELECTOR ‚îÄ‚îÄ */
    .year-bar {
      display: flex; align-items: center; gap: .75rem; flex-wrap: wrap;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius-xl); padding: .9rem 1.25rem;
      box-shadow: var(--shadow-sm); margin-bottom: 1.75rem;
    }
    .year-bar label { font-size: .72rem; font-weight: 700; text-transform: uppercase; letter-spacing: .08em; color: var(--text-muted); }
    .year-select {
      padding: .5rem 1rem; border: 1.5px solid var(--border); border-radius: 8px;
      font-family: 'Sora',sans-serif; font-size: .95rem; font-weight: 700;
      background: var(--surface); color: var(--text); cursor: pointer;
      transition: border-color .15s; min-width: 110px;
    }
    .year-select:focus { outline: none; border-color: var(--rojo); }
    .btn-load {
      padding: .5rem 1.15rem; background: var(--rojo); color: #fff;
      border: none; border-radius: 8px; font-family: 'Sora',sans-serif;
      font-size: .88rem; font-weight: 700; cursor: pointer;
      display: flex; align-items: center; gap: .4rem; transition: background .15s, transform .1s;
    }
    .btn-load:hover { background: var(--rojo-dark); }
    .btn-load:active { transform: scale(.98); }
    .year-status {
      margin-left: auto; display: flex; align-items: center; gap: .45rem;
      font-size: .78rem; color: var(--text-muted);
    }
    .dot { width: 7px; height: 7px; border-radius: 50%; background: #ccc; flex-shrink: 0; }
    .dot--ok { background: var(--verde); box-shadow: 0 0 6px rgba(34,197,94,.5); }
    .dot--err { background: var(--rojo); }
    .dot--load { background: var(--amber); animation: blink 1s infinite; }
    @keyframes blink { 0%,100%{opacity:1}50%{opacity:.3} }

    /* ‚îÄ‚îÄ KPI ROW ‚îÄ‚îÄ */
    .kpi-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 1rem; margin-bottom: 1.75rem;
    }
    .kpi {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius-lg); padding: 1.2rem 1.4rem;
      box-shadow: var(--shadow-sm); position: relative; overflow: hidden;
      transition: box-shadow .2s, transform .2s;
    }
    .kpi:hover { box-shadow: var(--shadow); transform: translateY(-2px); }
    .kpi::after {
      content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px;
      background: var(--rojo); transform: scaleX(0); transform-origin: left;
      transition: transform .3s ease;
    }
    .kpi:hover::after { transform: scaleX(1); }
    .kpi--hero {
      background: linear-gradient(135deg, var(--rojo) 0%, var(--rojo-dark) 100%);
      border-color: var(--rojo-dark); color: #fff;
    }
    .kpi--hero::after { display: none; }
    .kpi--hero .kpi-lbl { color: rgba(255,255,255,.7); }
    .kpi--hero .kpi-val { color: #fff; }
    .kpi--hero .kpi-sub { color: rgba(255,255,255,.6); }
    .kpi-icon { font-size: 1.3rem; margin-bottom: .5rem; }
    .kpi-lbl { font-size: .68rem; font-weight: 700; text-transform: uppercase; letter-spacing: .08em; color: var(--text-muted); margin-bottom: .25rem; }
    .kpi-val { font-size: 1.7rem; font-weight: 700; letter-spacing: -.04em; font-family: 'JetBrains Mono',monospace; line-height: 1; }
    .kpi-sub { font-size: .72rem; color: var(--text-muted); margin-top: .3rem; }
    .kpi-delta {
      display: inline-flex; align-items: center; gap: .2rem;
      padding: .15rem .45rem; border-radius: 20px; font-size: .68rem; font-weight: 700;
      margin-top: .35rem;
    }
    .kpi-delta--up { background: var(--verde-glass); color: #16a34a; }
    .kpi-delta--down { background: var(--rojo-glass); color: var(--rojo); }
    .kpi-delta--neutral { background: var(--amber-glass); color: #b45309; }

    /* ‚îÄ‚îÄ MAIN CHART (l√≠nea de crecimiento) ‚îÄ‚îÄ */
    .growth-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius-xl); padding: 1.5rem 1.75rem;
      box-shadow: var(--shadow-sm); margin-bottom: 1.75rem;
    }
    .chart-hdr {
      display: flex; align-items: flex-start; justify-content: space-between;
      flex-wrap: wrap; gap: .75rem; margin-bottom: 1.5rem;
    }
    .chart-hdr-left {}
    .chart-section-lbl {
      font-size: .68rem; font-weight: 700; text-transform: uppercase; letter-spacing: .09em;
      color: var(--text-light); margin-bottom: .2rem;
    }
    .chart-title { font-size: 1.1rem; font-weight: 700; letter-spacing: -.02em; }
    .chart-legend { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
    .legend-item { display: flex; align-items: center; gap: .35rem; font-size: .75rem; color: var(--text-muted); }
    .legend-line { width: 20px; height: 3px; border-radius: 2px; }
    .legend-dot-lg { width: 10px; height: 10px; border-radius: 50%; }

    /* SVG Chart */
    .chart-wrap { position: relative; width: 100%; }
    #growth-svg { width: 100%; display: block; }
    .chart-tooltip {
      position: absolute; background: var(--text); color: #fff;
      border-radius: 8px; padding: .5rem .75rem; font-size: .75rem;
      pointer-events: none; opacity: 0; transition: opacity .15s;
      white-space: nowrap; z-index: 10; transform: translateX(-50%);
    }
    .chart-tooltip strong { font-family: 'JetBrains Mono',monospace; font-size: .8rem; }

    /* ‚îÄ‚îÄ SECONDARY CHARTS ROW ‚îÄ‚îÄ */
    .secondary-row {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 1rem; margin-bottom: 1.75rem;
    }
    @media (max-width: 860px) { .secondary-row { grid-template-columns: 1fr; } }

    .sec-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius-lg); padding: 1.25rem 1.5rem;
      box-shadow: var(--shadow-sm);
    }

    /* Bar chart (columnas) */
    .col-chart { display: flex; align-items: flex-end; gap: 4px; height: 140px; padding-top: .5rem; }
    .col-wrap {
      flex: 1; display: flex; flex-direction: column; align-items: center;
      gap: .3rem; height: 100%;
    }
    .col-bar-wrap { flex: 1; width: 100%; display: flex; align-items: flex-end; }
    .col-bar {
      width: 100%; border-radius: 5px 5px 0 0;
      background: linear-gradient(180deg, var(--rojo-light) 0%, var(--rojo) 100%);
      transition: height .7s cubic-bezier(.34,1.56,.64,1);
      position: relative; cursor: pointer;
    }
    .col-bar:hover { background: linear-gradient(180deg, var(--rojo-xlight) 0%, var(--rojo-light) 100%); }
    .col-bar.col--best { background: linear-gradient(180deg, #ff6080 0%, var(--rojo-dark) 100%); }
    .col-lbl { font-size: .6rem; color: var(--text-light); font-weight: 600; text-align: center; }
    .col-empty { background: var(--surface3); border-radius: 5px 5px 0 0; cursor: default; }

    /* Horizontal bar (categor√≠a) */
    .hbar-list { display: flex; flex-direction: column; gap: .65rem; }
    .hbar-row { display: flex; align-items: center; gap: .75rem; }
    .hbar-lbl { font-size: .75rem; color: var(--text-muted); width: 90px; text-align: right; flex-shrink: 0; font-weight: 600; }
    .hbar-track { flex: 1; height: 20px; background: var(--bg); border-radius: 5px; overflow: hidden; }
    .hbar-fill {
      height: 100%; border-radius: 5px;
      transition: width .7s cubic-bezier(.34,1.56,.64,1);
    }
    .hbar-val { font-size: .7rem; font-family: 'JetBrains Mono',monospace; color: var(--text-muted); width: 70px; flex-shrink: 0; font-weight: 600; }

    /* ‚îÄ‚îÄ MONTH TABLE ‚îÄ‚îÄ */
    .month-table-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius-xl); overflow: hidden;
      box-shadow: var(--shadow-sm);
    }
    .month-table-hdr {
      padding: 1.1rem 1.5rem; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: .5rem;
      background: var(--surface2);
    }
    .section-label {
      font-size: .68rem; font-weight: 700; text-transform: uppercase; letter-spacing: .09em;
      color: var(--text-light); display: flex; align-items: center; gap: .5rem;
    }
    .section-label::before { content: ''; width: 3px; height: 13px; background: var(--rojo); border-radius: 2px; display: inline-block; }

    table { width: 100%; border-collapse: collapse; font-size: .82rem; }
    thead th {
      padding: .65rem 1.1rem; text-align: left; background: var(--rojo-glass);
      color: var(--rojo); font-size: .68rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: .07em; white-space: nowrap; border-bottom: 1px solid rgba(196,30,58,.12);
    }
    thead th.r { text-align: right; }
    tbody tr { border-bottom: 1px solid var(--border); transition: background .1s; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: var(--surface2); }
    tbody td { padding: .6rem 1.1rem; vertical-align: middle; }
    tbody td.r { text-align: right; font-family: 'JetBrains Mono',monospace; font-weight: 600; }
    tbody td.muted { color: var(--text-muted); font-size: .75rem; }
    .td-mes { font-weight: 700; }
    .td-monto { color: var(--rojo); }
    .delta-badge {
      display: inline-flex; align-items: center; gap: .2rem;
      padding: .15rem .5rem; border-radius: 20px; font-size: .68rem; font-weight: 700;
      font-family: 'JetBrains Mono',monospace;
    }
    .delta-badge--up { background: var(--verde-glass); color: #16a34a; }
    .delta-badge--down { background: var(--rojo-glass); color: var(--rojo); }
    .delta-badge--eq { background: var(--amber-glass); color: #b45309; }
    .mini-bar-wrap { display: flex; align-items: center; gap: .5rem; }
    .mini-bar { height: 6px; border-radius: 3px; background: var(--rojo); min-width: 2px; flex-shrink: 0; }
    .sin-datos { color: var(--text-light); font-size: .75rem; font-style: italic; }

    /* ‚îÄ‚îÄ EMPTY / LOADING ‚îÄ‚îÄ */
    .empty {
      text-align: center; padding: 4rem 2rem;
      color: var(--text-muted);
    }
    .empty-icon { font-size: 3rem; opacity: .3; margin-bottom: .75rem; }
    .empty-txt { font-size: .9rem; }
    [hidden] { display: none !important; }

    /* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(14px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .anim { animation: fadeUp .4s ease both; }
    .anim-d1 { animation-delay: .05s; }
    .anim-d2 { animation-delay: .10s; }
    .anim-d3 { animation-delay: .15s; }
    .anim-d4 { animation-delay: .20s; }
    .anim-d5 { animation-delay: .25s; }

    .loading-ring {
      display: inline-block; width: 15px; height: 15px;
      border: 2px solid rgba(196,30,58,.2); border-top-color: var(--rojo);
      border-radius: 50%; animation: spin .6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 600px) {
      .main { padding: 1rem 1rem 3rem; }
      .kpi-row { grid-template-columns: 1fr 1fr; }
      .secondary-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<!-- HEADER -->
<header class="hdr">
  <div class="hdr-brand">
    <h1>Panificacion Colombres</h1>
    <span>Sistema de Ventas</span>
  </div>
  <nav class="hdr-nav">
    <a href="../../Ventas/Seleccionar-cliente/seleccionar-cliente.html">Nueva venta</a>
    <a href="../../Ventas/Listado-Ventas/listado-ventas.html">Listado de ventas</a>
    <a href="../dashboard.html">Dashboard</a>
    <a href="dashboard-anual.html" class="active">Dashboard anual</a>
  </nav>
</header>

<main class="main">

  <!-- PAGE TITLE -->
  <div class="page-top">
    <div>
      <a href="../../../index.html" class="back-link">‚Üê Volver al inicio</a>
      <h1 class="page-title">An√°lisis anual <em id="titulo-anio">‚Äî</em></h1>
    </div>
  </div>

  <!-- YEAR BAR -->
  <div class="year-bar">
    <label for="sel-anio">A√±o</label>
    <select id="sel-anio" class="year-select"></select>
    <button class="btn-load" id="btn-cargar">
      <span id="btn-icon">‚Üª</span> Analizar a√±o
    </button>
    <div class="year-status">
      <div class="dot" id="status-dot"></div>
      <span id="status-txt">Seleccione un a√±o y cargue</span>
    </div>
  </div>

  <!-- KPIs -->
  <div class="kpi-row" id="kpi-row" hidden>
    <div class="kpi kpi--hero anim">
      <div class="kpi-icon">üí∞</div>
      <div class="kpi-lbl">Facturaci√≥n anual</div>
      <div class="kpi-val" id="kpi-anual">‚Äî</div>
      <div class="kpi-sub" id="kpi-anual-sub">acumulado del a√±o</div>
    </div>
    <div class="kpi anim anim-d1">
      <div class="kpi-icon">üìÖ</div>
      <div class="kpi-lbl">Mejor mes</div>
      <div class="kpi-val" id="kpi-mejor-val">‚Äî</div>
      <div class="kpi-sub" id="kpi-mejor-mes"></div>
    </div>
    <div class="kpi anim anim-d2">
      <div class="kpi-icon">üìä</div>
      <div class="kpi-lbl">Promedio mensual</div>
      <div class="kpi-val" id="kpi-prom">‚Äî</div>
      <div class="kpi-sub" id="kpi-prom-sub"></div>
    </div>
    <div class="kpi anim anim-d3">
      <div class="kpi-icon">üì¶</div>
      <div class="kpi-lbl">Total unidades</div>
      <div class="kpi-val" id="kpi-unidades">‚Äî</div>
      <div class="kpi-sub" id="kpi-unidades-sub"></div>
    </div>
    <div class="kpi anim anim-d4">
      <div class="kpi-icon">‚ö°</div>
      <div class="kpi-lbl">Crecimiento vs mes ant.</div>
      <div class="kpi-val" id="kpi-crec">‚Äî</div>
      <div class="kpi-sub" id="kpi-crec-sub"></div>
    </div>
  </div>

  <!-- GROWTH LINE CHART -->
  <div class="growth-card anim anim-d2" id="growth-card" hidden>
    <div class="chart-hdr">
      <div class="chart-hdr-left">
        <div class="chart-section-lbl">Evoluci√≥n temporal</div>
        <div class="chart-title">Facturaci√≥n mes a mes ¬∑ <span id="growth-year-lbl" style="color:var(--rojo)">‚Äî</span></div>
      </div>
      <div class="chart-legend">
        <div class="legend-item"><div class="legend-line" style="background:var(--rojo)"></div> Facturaci√≥n</div>
        <div class="legend-item"><div class="legend-line" style="background:var(--rojo-xlight); border-top: 2px dashed var(--rojo-light); height:0"></div> Tendencia</div>
        <div class="legend-item"><div class="legend-dot-lg" style="background:var(--verde)"></div> Crecimiento</div>
        <div class="legend-item"><div class="legend-dot-lg" style="background:var(--rojo-light)"></div> Ca√≠da</div>
      </div>
    </div>
    <div class="chart-wrap">
      <svg id="growth-svg" height="260"></svg>
      <div class="chart-tooltip" id="tooltip"></div>
    </div>
  </div>

  <!-- SECONDARY CHARTS -->
  <div class="secondary-row" id="sec-row" hidden>
    <!-- Column chart -->
    <div class="sec-card anim anim-d3">
      <div style="margin-bottom:.9rem">
        <div class="chart-section-lbl">Comparativa</div>
        <div class="chart-title" style="font-size:.95rem">Facturaci√≥n por mes</div>
      </div>
      <div class="col-chart" id="col-chart"></div>
    </div>

    <!-- Horizontal bars por categor√≠a -->
    <div class="sec-card anim anim-d4">
      <div style="margin-bottom:.9rem">
        <div class="chart-section-lbl">Composici√≥n</div>
        <div class="chart-title" style="font-size:.95rem">Ventas por categor√≠a (anual)</div>
      </div>
      <div class="hbar-list" id="hbar-list"></div>
    </div>
  </div>

  <!-- MONTHLY TABLE -->
  <div class="month-table-card anim anim-d5" id="table-card" hidden>
    <div class="month-table-hdr">
      <div class="section-label">Resumen mensual detallado</div>
      <div style="font-size:.75rem; color:var(--text-muted)" id="table-note"></div>
    </div>
    <div style="overflow-x:auto">
      <table>
        <thead>
          <tr>
            <th>Mes</th>
            <th class="r">Facturaci√≥n</th>
            <th class="r">Unidades</th>
            <th class="r">Ventas (#)</th>
            <th class="r">Ticket prom.</th>
            <th class="r">vs mes ant.</th>
            <th>Participaci√≥n</th>
          </tr>
        </thead>
        <tbody id="month-tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- EMPTY STATE -->
  <div class="empty" id="empty-state">
    <div class="empty-icon">üìà</div>
    <div class="empty-txt">Seleccione un a√±o y presione <strong>Analizar a√±o</strong> para cargar el dashboard completo</div>
  </div>

</main>

<div id="footer-container" data-footer-src="../../Footer/footer.html"></div>

<script src="../../Config/config.js"></script>
<script src="../../Config/tables.js"></script>
<script src="../../../main.js"></script>
<script src="../../Footer/footer.js"></script>
<script>
(function(){
'use strict';

/* ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ */
var APP_CONFIG   = window.APP_CONFIG;
var APP_TABLES   = window.APP_TABLES;
var SCRIPT_URL   = APP_CONFIG && APP_CONFIG.APP_SCRIPT_URL;
var CORS_PROXY   = APP_CONFIG && APP_CONFIG.CORS_PROXY;

var MESES = (APP_TABLES && APP_TABLES.NOMBRES_HOJAS_MES) || [
  'ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO',
  'JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'
];
var MESES_CORTOS = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];

var CAT_COLORS = {
  'SANDWICH':  '#C41E3A',
  'BEBIDA':    '#2563eb',
  'EMPANADA':  '#b45309',
  'POSTRE':    '#7c3aed',
};
function catColor(c){ return CAT_COLORS[String(c).toUpperCase()] || '#0f766e'; }

/* ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ */
function fmt(n){ return Number(n).toLocaleString('es-AR'); }
function fmtM(n){ return '$\u00a0'+Number(n).toLocaleString('es-AR',{minimumFractionDigits:0,maximumFractionDigits:0}); }
function pct(a,b){ if(!b) return null; return ((a-b)/b*100); }
function sign(n){ return n>0?'+':n<0?'‚àí':''; }

/* ‚îÄ‚îÄ YEAR SELECT ‚îÄ‚îÄ */
(function buildYears(){
  var sel = document.getElementById('sel-anio');
  var now = new Date().getFullYear();
  for(var y=now; y>=now-5; y--){
    var o=document.createElement('option'); o.value=y; o.textContent=y; sel.appendChild(o);
  }
})();

/* ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ */
function setStatus(type,txt){
  document.getElementById('status-dot').className = 'dot'+(type?' dot--'+type:'');
  document.getElementById('status-txt').textContent = txt;
}

/* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
document.getElementById('btn-cargar').addEventListener('click', cargarAnio);
cargarAnio(); // auto-load on page open

/* ‚îÄ‚îÄ LOAD YEAR ‚îÄ‚îÄ */
function cargarAnio(){
  var anio = document.getElementById('sel-anio').value;
  var anioNum = parseInt(anio, 10);
  document.getElementById('titulo-anio').textContent = anio;
  document.getElementById('growth-year-lbl').textContent = anio;

  if(!SCRIPT_URL){
    buildDemo(anioNum);
    return;
  }

  setStatus('load','Cargando todos los meses de '+anio+'‚Ä¶');
  var icon = document.getElementById('btn-icon');
  icon.innerHTML = '<span class="loading-ring"></span>';

  var promises = MESES.map(function(mes){
    var payload = { accion:'ventaLeer', hoja: mes };
    var body = 'data='+encodeURIComponent(JSON.stringify(payload));
    var url = (CORS_PROXY&&CORS_PROXY.length) ? CORS_PROXY+encodeURIComponent(SCRIPT_URL) : SCRIPT_URL;
    return fetch(url,{method:'POST',mode:'cors',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:body})
      .then(function(r){
        var ct = (r.headers.get('Content-Type')||'').toLowerCase();
        if(ct.indexOf('json')!==-1) return r.json();
        return r.text().then(function(t){ try{ return JSON.parse(t); } catch(e){ return {ok:false,datos:[]}; }; });
      })
      .then(function(d){ return {mes:mes, ok:d&&d.ok, datos:d&&d.datos?d.datos:[]}; })
      .catch(function(){ return {mes:mes, ok:false, datos:[]}; });
  });

  Promise.all(promises).then(function(results){
    icon.textContent='‚Üª';
    var mesData = {};
    results.forEach(function(r){
      var rows = (r.datos||[]).filter(function(row){
        var rowAnio = row.A√ëO !== undefined && row.A√ëO !== null && row.A√ëO !== '' ? parseInt(String(row.A√ëO), 10) : null;
        if(rowAnio !== null) return rowAnio === anioNum;
        var f = String(row.FECHA_OPERATIVA||row.FECHA||'');
        return f.indexOf(anio)!==-1 || !f;
      });
      mesData[r.mes] = rows;
    });
    processData(anioNum, mesData);
    setStatus('ok','A√±o '+anio+' cargado correctamente');
  }).catch(function(e){
    icon.textContent='‚Üª';
    setStatus('err','Error al cargar: '+(e.message||e));
  });
}

/* ‚îÄ‚îÄ DEMO DATA ‚îÄ‚îÄ */
function buildDemo(anio){
  var base = 45000;
  var patterns = [0.65, 0.72, 0.80, 0.88, 0.95, 1.10, 1.25, 1.15, 0.98, 1.30, 1.45, 1.60];
  var cats = ['SANDWICH','BEBIDA','EMPANADA','POSTRE'];
  var products = {
    SANDWICH: ['Lomito especial','Mila completo','Chorizo a la criolla','Lomito EL TOTI','Mila prueba'],
    BEBIDA:   ['Coca Cola 500ml','Mirinda 2L','Agua mineral','Sprite 500ml','Fanta naranja'],
    EMPANADA: ['Empanada carne','Empanada jam√≥n/queso','Empanada pollo','Empanada verdura'],
    POSTRE:   ['Flan con dulce','Brownie','Alfajor artesanal'],
  };
  var mesData = {};

  MESES.forEach(function(mes, mi){
    var factor = patterns[mi] * (0.85 + Math.random()*.3);
    var nRows = Math.floor(15 + Math.random()*25);
    var rows = [];
    for(var i=0;i<nRows;i++){
      var cat = cats[Math.floor(Math.random()*cats.length)];
      var prods = products[cat];
      var prod = prods[Math.floor(Math.random()*prods.length)];
      var precio = cat==='SANDWICH'?3000+Math.floor(Math.random()*1500)
                 : cat==='BEBIDA'?600+Math.floor(Math.random()*800)
                 : cat==='EMPANADA'?500+Math.floor(Math.random()*300)
                 : 800+Math.floor(Math.random()*600);
      var cant = 1+Math.floor(Math.random()*4);
      var day = 1+Math.floor(Math.random()*28);
      var ds = String(day).padStart(2,'0');
      var ms = String(mi+1).padStart(2,'0');
      rows.push({
        MES: mes,
        A√ëO: anio,
        'ID-VENTA': 'V-'+anio+String(mi+1).padStart(2,'0')+String(i+1).padStart(3,'0'),
        FECHA_OPERATIVA: anio+'-'+ms+'-'+ds,
        HORA: '1899-12-30T'+(10+Math.floor(Math.random()*8)).toString().padStart(2,'0')+':'+String(Math.floor(Math.random()*60)).padStart(2,'0')+':00.000Z',
        CATEGORIA: cat,
        'ID-PRODUCTO': 'IDPROD-'+prod.replace(/ /g,'-').toUpperCase().substring(0,12),
        PRODUCTO: prod,
        CANTIDAD: cant,
        PRECIO: Math.round(precio * factor),
        MONTO: Math.round(precio * factor * cant),
      });
    }
    mesData[mes] = rows;
  });
  processData(anio, mesData);
  setStatus('ok','A√±o '+anio+' (demo) ‚Äî conecte APP_SCRIPT_URL para datos reales');
}

/* ‚îÄ‚îÄ PROCESS ‚îÄ‚îÄ */
function processData(anio, mesData){
  var meses = MESES.map(function(m,i){
    var rows = mesData[m]||[];
    var monto = rows.reduce(function(s,r){return s+(parseFloat(r.MONTO)||0);},0);
    var unidades = rows.reduce(function(s,r){return s+(parseFloat(r.CANTIDAD)||0);},0);
    var idsVenta = {};
    rows.forEach(function(r){ if(r['ID-VENTA']) idsVenta[r['ID-VENTA']]=1; });
    var nVentas = Object.keys(idsVenta).length || rows.length;
    var cats = {};
    rows.forEach(function(r){
      var c=r.CATEGORIA||'OTRO';
      cats[c]=(cats[c]||0)+(parseFloat(r.MONTO)||0);
    });
    return {
      mes: m, mesCorto: MESES_CORTOS[i], idx: i,
      monto: monto, unidades: unidades, nVentas: nVentas,
      ticket: nVentas ? monto/nVentas : 0,
      cats: cats,
      hasData: rows.length > 0,
    };
  });

  var totalAnual = meses.reduce(function(s,m){return s+m.monto;},0);
  var mesesConDatos = meses.filter(function(m){return m.hasData;});
  var promMensual = mesesConDatos.length ? totalAnual/mesesConDatos.length : 0;
  var totalUnidades = meses.reduce(function(s,m){return s+m.unidades;},0);
  var mejorMes = mesesConDatos.reduce(function(a,b){return b.monto>a.monto?b:a;}, mesesConDatos[0]||meses[0]);

  var conDatos = meses.filter(function(m){return m.hasData;});
  var lastIdx = conDatos.length-1;
  var ultCrm = conDatos[lastIdx], antCrm = conDatos[lastIdx-1];
  var crecimiento = (ultCrm&&antCrm) ? pct(ultCrm.monto,antCrm.monto) : null;

  var catGlobal = {};
  meses.forEach(function(m){ Object.keys(m.cats).forEach(function(c){ catGlobal[c]=(catGlobal[c]||0)+m.cats[c]; }); });

  renderKPIs(totalAnual, promMensual, totalUnidades, mejorMes, crecimiento, ultCrm, antCrm);
  renderGrowthChart(meses, totalAnual);
  renderColChart(meses, mejorMes);
  renderHBar(catGlobal, totalAnual);
  renderTable(meses, totalAnual);

  ['kpi-row','growth-card','sec-row','table-card'].forEach(function(id){ document.getElementById(id).hidden=false; });
  document.getElementById('empty-state').hidden=true;
}

/* ‚îÄ‚îÄ KPIs ‚îÄ‚îÄ */
function renderKPIs(total, prom, unidades, mejor, crec, ult, ant){
  document.getElementById('kpi-anual').textContent = fmtM(total);
  document.getElementById('kpi-mejor-val').textContent = fmtM(mejor.monto);
  document.getElementById('kpi-mejor-mes').textContent = mejor.mes;
  document.getElementById('kpi-prom').textContent = fmtM(prom);
  document.getElementById('kpi-prom-sub').textContent = 'por mes activo';
  document.getElementById('kpi-unidades').textContent = fmt(unidades);
  document.getElementById('kpi-unidades-sub').textContent = 'productos despachados';

  var crecEl = document.getElementById('kpi-crec');
  var crecSub = document.getElementById('kpi-crec-sub');
  if(crec!==null){
    var v = crec.toFixed(1);
    crecEl.textContent = sign(crec)+Math.abs(v)+'%';
    crecEl.style.color = crec>=0?'var(--verde)':'var(--rojo)';
    crecSub.textContent = (ult?ult.mesCorto:'') + ' vs ' + (ant?ant.mesCorto:'');
  } else {
    crecEl.textContent = '‚Äî'; crecSub.textContent = 'sin datos comparables';
  }
}

/* ‚îÄ‚îÄ LINE CHART ‚îÄ‚îÄ */
function renderGrowthChart(meses, totalAnual){
  var svg = document.getElementById('growth-svg');
  var W = svg.parentElement.offsetWidth || 900;
  var H = 260;
  var PAD = { top:30, right:24, bottom:44, left:72 };
  var chartW = W - PAD.left - PAD.right;
  var chartH = H - PAD.top - PAD.bottom;

  var conDatos = meses.filter(function(m){return m.hasData;});
  if(!conDatos.length){ svg.innerHTML=''; return; }

  var maxVal = Math.max.apply(null, meses.map(function(m){return m.monto;}));
  var minVal = 0;
  var range = maxVal - minVal || 1;

  function xPos(idx){ return PAD.left + (idx / (meses.length-1)) * chartW; }
  function yPos(v){ return PAD.top + chartH - ((v - minVal)/range)*chartH; }

  var ns = 'http://www.w3.org/2000/svg';
  svg.setAttribute('viewBox','0 0 '+W+' '+H);
  svg.setAttribute('height', H);
  svg.innerHTML = '';

  for(var s=0; s<=4; s++){
    var gv = minVal + (range/4)*s;
    var gy = yPos(gv);
    var gline = document.createElementNS(ns,'line');
    gline.setAttribute('x1',PAD.left); gline.setAttribute('x2',W-PAD.right);
    gline.setAttribute('y1',gy); gline.setAttribute('y2',gy);
    gline.setAttribute('stroke','#e6e2dd'); gline.setAttribute('stroke-width','1');
    if(s===0) gline.setAttribute('stroke','#ccc');
    svg.appendChild(gline);
    var glbl = document.createElementNS(ns,'text');
    glbl.setAttribute('x',PAD.left-8); glbl.setAttribute('y',gy+4);
    glbl.setAttribute('text-anchor','end'); glbl.setAttribute('font-size','10');
    glbl.setAttribute('fill','#b5b0aa'); glbl.setAttribute('font-family','JetBrains Mono,monospace');
    glbl.textContent = gv>=1000 ? '$'+(gv/1000).toFixed(0)+'k' : '$'+gv;
    svg.appendChild(glbl);
  }

  var areaPoints = meses.map(function(m,i){ return [xPos(i), yPos(m.monto)]; });
  var areaPath = 'M'+PAD.left+','+(PAD.top+chartH)+' ';
  areaPoints.forEach(function(p){ areaPath += 'L'+p[0]+','+p[1]+' '; });
  areaPath += 'L'+(W-PAD.right)+','+(PAD.top+chartH)+' Z';

  var defs = document.createElementNS(ns,'defs');
  var grad = document.createElementNS(ns,'linearGradient');
  grad.setAttribute('id','area-grad'); grad.setAttribute('x1','0'); grad.setAttribute('y1','0');
  grad.setAttribute('x2','0'); grad.setAttribute('y2','1');
  var s1=document.createElementNS(ns,'stop'); s1.setAttribute('offset','0%'); s1.setAttribute('stop-color','rgba(196,30,58,0.18)'); grad.appendChild(s1);
  var s2=document.createElementNS(ns,'stop'); s2.setAttribute('offset','100%'); s2.setAttribute('stop-color','rgba(196,30,58,0)'); grad.appendChild(s2);
  defs.appendChild(grad); svg.appendChild(defs);

  var area = document.createElementNS(ns,'path');
  area.setAttribute('d',areaPath); area.setAttribute('fill','url(#area-grad)');
  svg.appendChild(area);

  function smoothPath(pts){
    if(pts.length<2) return '';
    var d = 'M'+pts[0][0]+','+pts[0][1];
    for(var i=0;i<pts.length-1;i++){
      var cp1x=pts[i][0]+(pts[i+1][0]-pts[i][0])/3;
      var cp1y=pts[i][1];
      var cp2x=pts[i+1][0]-(pts[i+1][0]-pts[i][0])/3;
      var cp2y=pts[i+1][1];
      d+=' C'+cp1x+','+cp1y+' '+cp2x+','+cp2y+' '+pts[i+1][0]+','+pts[i+1][1];
    }
    return d;
  }
  var linePath = document.createElementNS(ns,'path');
  linePath.setAttribute('d', smoothPath(areaPoints));
  linePath.setAttribute('fill','none'); linePath.setAttribute('stroke','var(--rojo)');
  linePath.setAttribute('stroke-width','2.5'); linePath.setAttribute('stroke-linecap','round');
  var len = linePath.getTotalLength ? linePath.getTotalLength() : 2000;
  linePath.setAttribute('stroke-dasharray',len); linePath.setAttribute('stroke-dashoffset',len);
  linePath.style.transition='stroke-dashoffset 1.2s cubic-bezier(.4,0,.2,1)';
  svg.appendChild(linePath);
  setTimeout(function(){ linePath.setAttribute('stroke-dashoffset','0'); },100);

  var validPts = meses.map(function(m,i){ return m.hasData?[i,m.monto]:null; }).filter(Boolean);
  if(validPts.length>=2){
    var n=validPts.length, sx=0,sy=0,sxy=0,sxx=0;
    validPts.forEach(function(p){ sx+=p[0];sy+=p[1];sxy+=p[0]*p[1];sxx+=p[0]*p[0]; });
    var slope=(n*sxy-sx*sy)/(n*sxx-sx*sx);
    var intercept=(sy-slope*sx)/n;
    var tx1=xPos(0), ty1=yPos(intercept);
    var tx2=xPos(meses.length-1), ty2=yPos(slope*(meses.length-1)+intercept);
    var tline=document.createElementNS(ns,'line');
    tline.setAttribute('x1',tx1);tline.setAttribute('y1',ty1);
    tline.setAttribute('x2',tx2);tline.setAttribute('y2',ty2);
    tline.setAttribute('stroke','rgba(196,30,58,.3)'); tline.setAttribute('stroke-width','1.5');
    tline.setAttribute('stroke-dasharray','5 4');
    svg.appendChild(tline);
  }

  var tooltip = document.getElementById('tooltip');
  meses.forEach(function(m,i){
    var cx=xPos(i), cy=yPos(m.monto);
    var lbl=document.createElementNS(ns,'text');
    lbl.setAttribute('x',cx); lbl.setAttribute('y',PAD.top+chartH+16);
    lbl.setAttribute('text-anchor','middle'); lbl.setAttribute('font-size','10');
    lbl.setAttribute('fill',m.hasData?'#7a7370':'#ccc');
    lbl.setAttribute('font-family','Sora,sans-serif'); lbl.setAttribute('font-weight','600');
    lbl.textContent = m.mesCorto;
    svg.appendChild(lbl);

    if(!m.hasData) return;

    var prev = i>0?meses[i-1]:null;
    var growing = prev&&prev.hasData ? m.monto>prev.monto : null;
    var dotColor = growing===null?'var(--rojo)' : growing?'var(--verde)':'var(--rojo-light)';

    var oc=document.createElementNS(ns,'circle');
    oc.setAttribute('cx',cx);oc.setAttribute('cy',cy);oc.setAttribute('r','7');
    oc.setAttribute('fill','rgba(255,255,255,.9)'); oc.setAttribute('stroke',dotColor); oc.setAttribute('stroke-width','2');
    svg.appendChild(oc);

    var ic=document.createElementNS(ns,'circle');
    ic.setAttribute('cx',cx);ic.setAttribute('cy',cy);ic.setAttribute('r','3.5');
    ic.setAttribute('fill',dotColor); ic.style.cursor='pointer';
    svg.appendChild(ic);

    var hit=document.createElementNS(ns,'circle');
    hit.setAttribute('cx',cx); hit.setAttribute('cy',cy); hit.setAttribute('r','18');
    hit.setAttribute('fill','transparent'); hit.style.cursor='pointer';
    (function(month, px, py){
      var p = prev&&prev.hasData ? pct(month.monto,prev.monto) : null;
      var pStr = p!==null ? (sign(p)+Math.abs(p.toFixed(1))+'%') : '';
      hit.addEventListener('mouseenter',function(){
        tooltip.style.opacity='1';
        tooltip.style.left=px+'px'; tooltip.style.top=(py-48)+'px';
        tooltip.innerHTML='<strong>'+fmtM(month.monto)+'</strong> ¬∑ '+month.mes+(pStr?'<br><span style="color:'+(p>=0?'#22c55e':'#e84a67')+'">'+pStr+' vs ant.</span>':'');
      });
      hit.addEventListener('mouseleave',function(){ tooltip.style.opacity='0'; });
    })(m, cx, cy);
    svg.appendChild(hit);

    if(m.monto === Math.max.apply(null, meses.map(function(x){return x.monto;}))){
      var vl=document.createElementNS(ns,'text');
      vl.setAttribute('x',cx); vl.setAttribute('y',cy-14);
      vl.setAttribute('text-anchor','middle'); vl.setAttribute('font-size','9');
      vl.setAttribute('fill','var(--rojo)'); vl.setAttribute('font-weight','700');
      vl.setAttribute('font-family','JetBrains Mono,monospace');
      vl.textContent='‚òÖ '+fmtM(m.monto);
      svg.appendChild(vl);
    }
  });
}

/* ‚îÄ‚îÄ COLUMN CHART ‚îÄ‚îÄ */
function renderColChart(meses, mejorMes){
  var container = document.getElementById('col-chart');
  container.innerHTML='';
  var max = Math.max.apply(null, meses.map(function(m){return m.monto;})) || 1;

  meses.forEach(function(m){
    var wrap = document.createElement('div'); wrap.className='col-wrap';
    var barWrap=document.createElement('div'); barWrap.className='col-bar-wrap';
    var bar=document.createElement('div');
    bar.className='col-bar'+(m===mejorMes?' col--best':'');
    if(!m.hasData){ bar.className='col-bar col-empty'; bar.style.height='4px'; }
    else {
      bar.style.height='0%';
      bar.title=m.mes+': '+fmtM(m.monto);
      setTimeout(function(){ bar.style.height=Math.max((m.monto/max)*100,2)+'%'; },80);
    }
    var lbl=document.createElement('div'); lbl.className='col-lbl';
    lbl.textContent=m.mesCorto;
    barWrap.appendChild(bar);
    wrap.appendChild(barWrap); wrap.appendChild(lbl);
    container.appendChild(wrap);
  });
}

/* ‚îÄ‚îÄ HORIZONTAL BARS ‚îÄ‚îÄ */
function renderHBar(catGlobal, totalAnual){
  var list=document.getElementById('hbar-list'); list.innerHTML='';
  var sorted=Object.keys(catGlobal).map(function(k){return{name:k,val:catGlobal[k]};});
  sorted.sort(function(a,b){return b.val-a.val;});
  var maxCat=sorted[0]?sorted[0].val:1;

  sorted.forEach(function(cat){
    var row=document.createElement('div'); row.className='hbar-row';
    var pctVal=Math.round(cat.val/totalAnual*100);
    row.innerHTML=
      '<div class="hbar-lbl">'+cat.name+'</div>'+
      '<div class="hbar-track"><div class="hbar-fill" style="width:0%;background:'+catColor(cat.name)+'" data-w="'+(cat.val/maxCat*100)+'%"></div></div>'+
      '<div class="hbar-val">'+fmtM(cat.val)+'<br><span style="font-size:.62rem;color:var(--text-light)">'+pctVal+'%</span></div>';
    list.appendChild(row);
  });
  setTimeout(function(){
    list.querySelectorAll('.hbar-fill').forEach(function(el){
      el.style.transition='width .8s cubic-bezier(.34,1.56,.64,1)';
      el.style.width=el.getAttribute('data-w');
    });
  },100);
}

/* ‚îÄ‚îÄ MONTH TABLE ‚îÄ‚îÄ */
function renderTable(meses, totalAnual){
  var tbody=document.getElementById('month-tbody'); tbody.innerHTML='';
  var maxMonto=Math.max.apply(null,meses.map(function(m){return m.monto;})) || 1;
  var mesesConDatos=meses.filter(function(m){return m.hasData;});

  document.getElementById('table-note').textContent=
    mesesConDatos.length+' de 12 meses con datos registrados';

  meses.forEach(function(m,i){
    var tr=document.createElement('tr');
    var prev=i>0?meses[i-1]:null;
    var delta=(prev&&prev.hasData&&m.hasData)?pct(m.monto,prev.monto):null;
    var barW=Math.round((m.monto/maxMonto)*120);
    var partPct=totalAnual?Math.round(m.monto/totalAnual*100):0;

    var deltaHtml='<span class="sin-datos">‚Äî</span>';
    if(delta!==null){
      var cls=delta>0?'up':delta<0?'down':'eq';
      var arr=delta>0?'‚Üë':delta<0?'‚Üì':'‚Üí';
      deltaHtml='<span class="delta-badge delta-badge--'+cls+'">'+arr+' '+Math.abs(delta.toFixed(1))+'%</span>';
    }

    if(!m.hasData){
      tr.innerHTML=
        '<td class="td-mes" style="color:var(--text-light)">'+m.mes+'</td>'+
        '<td class="r sin-datos">Sin datos</td>'+
        '<td class="r muted">‚Äî</td><td class="r muted">‚Äî</td><td class="r muted">‚Äî</td>'+
        '<td class="r">'+deltaHtml+'</td>'+
        '<td><span style="font-size:.7rem;color:var(--text-light)">0%</span></td>';
    } else {
      tr.innerHTML=
        '<td class="td-mes">'+m.mes+'</td>'+
        '<td class="r td-monto">'+fmtM(m.monto)+'</td>'+
        '<td class="r muted">'+fmt(m.unidades)+'</td>'+
        '<td class="r muted">'+fmt(m.nVentas)+'</td>'+
        '<td class="r muted">'+fmtM(m.ticket)+'</td>'+
        '<td class="r">'+deltaHtml+'</td>'+
        '<td><div class="mini-bar-wrap">'+
          '<div class="mini-bar" style="width:0;transition:width .7s ease" data-w="'+barW+'px"></div>'+
          '<span style="font-size:.7rem;color:var(--text-muted)">'+partPct+'%</span>'+
        '</div></td>';
    }
    tbody.appendChild(tr);
  });

  setTimeout(function(){
    tbody.querySelectorAll('.mini-bar').forEach(function(el){
      el.style.width=el.getAttribute('data-w');
    });
  },150);
}

var resizeTimer;
window.addEventListener('resize',function(){
  clearTimeout(resizeTimer);
  resizeTimer=setTimeout(function(){
    var tbody=document.getElementById('month-tbody');
    if(tbody && tbody.children.length){
      var svg=document.getElementById('growth-svg');
      if(svg && svg.getAttribute('viewBox')){
        document.getElementById('btn-cargar').click();
      }
    }
  },400);
});

})();
</script>
</body>
</html>
